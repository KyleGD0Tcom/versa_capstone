{% extends 'warehouse/warehouse_base.html' %}
{% load static %}
{% block content %}


<head>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<style>
    body {
        font-family: 'Rubik', sans-serif;
    }

    #search1 {
        height: 40px;
        border: none;
        background-color: rgb(224, 224, 224);
        border-radius: 10px;
        padding: 20px;
        width: 300px;
    }
</style>

<div class="container-fluid px-5">
    <!-- Greeting and Search -->
    <i>Warehouse Department | Spare Parts Listings</i>
    <div class="row mb-5 mt-3 px-3"><input class="p-3" type="search" id="search1" placeholder="search"></div>




    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold" style="color: #033b60;">Spare Parts Listings</h4>
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center">
                    <!-- <span class="text-muted small me-2">Real-time updates</span>
                    <div id="inventoryUpdateIndicator" class="spinner-border spinner-border-sm text-primary" role="status" style="display: none;">
                        <span class="visually-hidden">Updating...</span>
                    </div> -->
                </div>
                <!-- Filter by Dropdown -->
                <div class="d-flex align-items-center">
                    <span class="text-secondary me-2">Filter by:</span>
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option selected>Select</option>
                        <option>Filtration System</option>
                        <option>Hydraulics</option>
                        <option>Electrical</option>
                    </select>
                </div>
                <!-- Pagination -->
                <div class="d-flex align-items-center">
                    <button class="btn btn-lg me-2">&lt;</button>
                    <span class="text-secondary">Page 1 of 1</span>
                    <button class="btn btn-lg ms-2">&gt;</button>
                </div>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-2 g-4">
            {% for item in items %}
            <div class="col">
                <div class="card p-3 shadow-sm h-100">
                    <div class="row g-3">
                        <!-- Image Column (4 out of 12 columns on medium+) -->
                        <div class="col-4">
                            {% if item.photo %}
                                <img src="{{ item.photo.url }}" alt="Item Photo" class="img-fluid rounded" style="min-height: 100%; max-height: 100%; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="min-height: 100%; max-height: 100%;">
                                    <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                </div>
                            {% endif %}
                        </div>
                        <!-- Text Column -->
                        <div class="col-8">
                            <div class="d-flex align-items-center mb-4 mt-3">
                                <span class="sp-code me-2"
                                    style="font-size: 0.75rem; font-weight: bold; background-color: #f0f0f0; border-radius: 5px; padding: 2px 6px;">{{ item.item_code }}</span>
                                <h6 class="mb-0 fw-bold" style="color: #033b60;">{{ item.unit_item }}</h6>
                            </div>
                            <div class="mb-1 d-flex">
                                <span style="width: 150px;" class="text-secondary">Serial Number:</span>
                                <span>{{ item.serial_number }}</span>
                            </div>
                            <div class="mb-1 d-flex ">
                                <span style="width: 150px;" class="text-secondary">Category:</span>
                                <span>{{ item.category }}</span>
                            </div>
                            <div class="mb-1 d-flex ">
                                <span style="width: 150px;" class="text-secondary">Quantity:</span>
                                <span>{{ item.quantity }}</span>
                            </div>

                            <div class="mb-0">
                                <span class="text-secondary">Description:</span>
                                <p style="margin-left: 45%; margin-top: -5%;">{{ item.details }}</p>
                                
                            </div>
                            <div class="mb-0 d-flex">
                                <span style="width: 150px;" class="text-secondary">Unit Price:</span>
                                <span>â‚± {{ item.unit_price }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let lastInventoryData = null;
    let isInitialLoad = true;
    
    function updateInventoryQuantities(items) {
        // Update quantities for matching items using the feed data
        const currentCards = document.querySelectorAll('.card');
        
        items.forEach(item => {
            const itemCode = item.item_code;
            const newQuantity = item.quantity;
            
            // Find matching card in current page
            currentCards.forEach(currentCard => {
                const currentItemCode = currentCard.querySelector('.sp-code')?.textContent.trim();
                if (currentItemCode === itemCode) {
                    // Find all divs with mb-1 d-flex class
                    const allRows = currentCard.querySelectorAll('.mb-1.d-flex');
                    
                    // Find the quantity row (the one that contains "Quantity:")
                    let quantityElement = null;
                    allRows.forEach(row => {
                        const firstSpan = row.querySelector('span:first-child');
                        if (firstSpan && firstSpan.textContent.trim() === 'Quantity:') {
                            quantityElement = row.querySelector('span:last-child');
                        }
                    });
                    
                    if (quantityElement) {
                        const currentQuantity = parseInt(quantityElement.textContent.trim());
                        const updatedQuantity = parseInt(newQuantity);
                        
                        // Only update if quantity has changed
                        if (currentQuantity !== updatedQuantity) {
                            quantityElement.textContent = newQuantity;
                            
                            // Add visual indicator for quantity change
                            quantityElement.style.backgroundColor = '#fff3cd';
                            quantityElement.style.padding = '2px 6px';
                            quantityElement.style.borderRadius = '4px';
                            quantityElement.style.transition = 'background-color 0.3s ease';
                            
                            // Remove highlight after 3 seconds
                            setTimeout(() => {
                                quantityElement.style.backgroundColor = '';
                                quantityElement.style.padding = '';
                                quantityElement.style.borderRadius = '';
                            }, 3000);
                        }
                    }
                }
            });
        });
    }
    
    function fetchInventoryFeed() {
        const indicator = document.getElementById('inventoryUpdateIndicator');
        if (indicator) {
            indicator.style.display = 'inline-block';
        }
        
        // Check for inventory updates every 3 seconds
        fetch('/warehouse/api/inventory-feed/', { 
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(function(res) { 
                if (!res.ok) {
                    throw new Error('Network response was not ok');
                }
                return res.json(); 
            })
            .then(function(data) {
                const items = data && Array.isArray(data.items) ? data.items : [];
                
                // Compare current data with previous data to detect changes
                const currentDataString = JSON.stringify(items);
                if (currentDataString !== lastInventoryData) {
                    lastInventoryData = currentDataString;
                    
                    // Only update if not initial load and there are actual changes
                    if (!isInitialLoad) {
                        updateInventoryQuantities(items);
                    }
                }
                
                // Mark initial load as complete after first fetch
                if (isInitialLoad) {
                    isInitialLoad = false;
                }
            })
            .catch(function(err) { 
                console.error('Inventory feed error:', err);
            })
            .finally(function() {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            });
    }

    // Initial load
    fetchInventoryFeed();
    
    // Set up polling every 3 seconds for inventory updates
    setInterval(fetchInventoryFeed, 3000);
});
</script>

{% endblock %}