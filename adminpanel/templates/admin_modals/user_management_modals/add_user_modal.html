<!-- templates/adminpanel/add_user_modal.html -->
{% load static %}
<style>
  #navytext {
    color: #033b60 !important;
  }

  #input {
    background-color: #eef0f5;
    border: none;
  }

  /* Optional: Style for invalid fields */
  .is-invalid {
    border-color: red;
  }
</style>

<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-3 p-5">
      <div class="d-flex justify-content-between align-items-start mb-4">
        <h5 class="fw-bold" id="navytext">Add New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{% url 'user_management' %}" id="addUserForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row">
          <!-- Profile Picture -->
          <div class="col-md-3 text-center mb-4">
            <img id="profilePreview" src="{% static 'images/user.png' %}" class="rounded-circle border mb-2" width="100" height="100" style="object-fit: cover;">
            <div>
              <input type="file" id="profilePicture" name="profile_picture" accept="image/*" style="display: none;">
              <a href="#" id="addProfileBtn" class="small text-primary text-decoration-none">+ Add profile picture</a>
            </div>
          </div>

          <!-- Form Content -->
          <div class="col-md-9">
            <!-- Personal Info -->
            <h6 class="text-secondary small fst-italic" id="navytext">Personal Information</h6>
            <div class="row g-2 mb-3">
              <div class="col-md-12">
                <label class="form-label small">Username</label>
                <input type="text" name="username" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label small">First Name</label>
                <input type="text" name="first_name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Last Name</label>
                <input type="text" name="last_name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Gender</label>
                <select class="form-select" name="gender" required>
                  <option selected disabled>Please select</option>
                  <option>Male</option>
                  <option>Female</option>
                  <option>Non-binary</option>
                  <option>Prefer not to say</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Date of Birth</label>
                <input type="date" name="dob" class="form-control" required>
              </div>
              <div class="col-md-12">
                <label class="form-label small">Email</label>
                <input type="email" name="email" class="form-control" required>
              </div>
              <div class="col-md-12">
                <label class="form-label small">Mobile Number</label>
                <input type="text" name="mobile_number" class="form-control">
              </div>
            </div>

            <!-- Job Info -->
            <h6 class="text-secondary small fst-italic" id="navytext">Job Information</h6>
            <div class="row g-2 mb-3">
              <div class="col-md-6">
                <label class="form-label small">Department</label>
                <select class="form-select" name="department" required>
                  <option selected disabled>Please select</option>
                  {% for group in groups %}
                  <option value="{{ group.name }}">{{ group.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Role</label>
                <select class="form-select" name="role" required>
                  <option selected disabled>Please select</option>
                  <option value="Manager">Manager</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label small">Work Shift Hours</label>
                <select class="form-select" name="work_shift" required>
                  <option selected disabled>Select Shift</option>
                  <option>09:00 AM - 05:00 PM</option>
                  <option>08:00 AM - 04:00 PM</option>
                  <option>10:00 AM - 06:00 PM</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Employee Status</label>
                <select class="form-select" name="status" required>
                  <option selected disabled>Please select</option>
                  <option>Full-time</option>
                  <option>Part-time</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Employee Type</label>
                <select class="form-select" name="employee_type" required>
                  <option selected disabled>Please select</option>
                  <option>Permanent</option>
                  <option>Temporary</option>
                  <option>Intern</option>
                </select>
              </div>
            </div>
            <h6 class="text-secondary small fst-italic" id="navytext">Credentials</h6>
            <div class="col-md-12">
              <label class="form-label small">Assign Temporary Password</label>
              <input type="password" name="password" class="form-control" required>
            </div>

          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" name="add_user" class="btn text-white px-4"
            style="background-color: #53893c;">Confirm</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.getElementById("addUserForm").addEventListener("submit", function (event) {
    // Prevent form submission if validation fails
    let form = event.target;

    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
      alert("Please fill out all required fields.");
    }

    form.classList.add("was-validated");
  }, false);

  // Profile picture upload functionality
  document.addEventListener('DOMContentLoaded', function() {
    const profilePictureInput = document.getElementById('profilePicture');
    const profilePreview = document.getElementById('profilePreview');
    const addProfileBtn = document.getElementById('addProfileBtn');

    // Trigger file input when clicking the "Add profile picture" link
    addProfileBtn.addEventListener('click', function(e) {
      e.preventDefault();
      profilePictureInput.click();
    });

    // Handle file selection and preview
    profilePictureInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB.');
          return;
        }

        // Create preview
        const reader = new FileReader();
        reader.onload = function(e) {
          profilePreview.src = e.target.result;
        };
        reader.readAsDataURL(file);

        // Update the link text
        addProfileBtn.textContent = 'Change profile picture';
      }
    });
  });
</script>