{% extends 'aftersales/aftersales_base.html' %}
{% load static %}
{% block content %}

<head>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<style>
    body {
        font-family: 'Rubik', sans-serif;
    }

    #search1 {
        height: 40px;
        border: none;
        background-color: rgb(224, 224, 224);
        border-radius: 10px;
        padding: 20px;
        width: 300px;
    }
</style>

<script>
    function sendToMaintenance(serviceId) {
        const button = document.querySelector(`button[onclick="sendToMaintenance('${serviceId}')"]`);
        if (button.disabled) {
            return;
        }

        // Get the service record data from the modal
        const modal = document.getElementById(`viewServiceRecordModal${serviceId}`);
        if (!modal) {
            console.error('Modal not found:', `viewServiceRecordModal${serviceId}`);
            return;
        }

        const unitName = modal.querySelector('[data-field="unit_name"]');
        const serialNumber = modal.querySelector('[data-field="serial_number"]');
        const clientName = modal.querySelector('[data-field="client_name"]');

        if (!unitName || !serialNumber || !clientName) {
            console.error('Required fields not found:', {
                unitName: !!unitName,
                serialNumber: !!serialNumber,
                clientName: !!clientName
            });
            return;
        }

        const serviceData = {
            service_id: serviceId,
            unit_name: unitName.textContent.trim(),
            serial_number: serialNumber.textContent.trim(),
            client_name: clientName.textContent.trim(),
        };

        console.log('Sending data:', serviceData);

        // Send the data to create a new maintenance record
        fetch('/aftersales/create_maintenance/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(serviceData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response:', data);
            if (data.success) {
                // Disable the button and update its text
                button.disabled = true;
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
                button.innerHTML = '<i class="bi bi-tools me-2"></i>Already Sent to Maintenance';
                
                // Close the modal
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Show success message
                alert('Successfully sent to maintenance!');
                
                // Redirect to maintenance schedule page using the URL from the response
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = '/aftersales/maintenance_schedule/';
                }
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while sending to maintenance: ' + error.message);
        });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<div class="container-fluid px-5">
    <div class="row mb-3 fst-italic">Aftersales Department | Service Records</div>
    <div class="d-flex gap-5">
        <div class="row mb-5">
            <input class="p-2" type="search" id="search1" placeholder="search"
                style="height: 40px; border: none; background-color: rgb(224, 224, 224); border-radius: 10px; padding: 20px; width: 300px;">
        </div>
    </div>

    <!-- Header-->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fs-4 fw-bold mb-4" style="color: #033b60;">Service Records</h5>
    </div>
    <div class="table-responsive border rounded-3 p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <input type="text" class="form-control w-25 mb-3 ms-3" placeholder="Search">
            <div class="d-flex align-items-center gap-2 ms-auto">
                <span class="text-secondary small">Filter by:</span>
                <select class="form-select form-select-sm" style="width: auto;">
                    <option selected>Select</option>
                    <option>Status</option>
                    <option>Warranty</option>
                </select>
            </div>
        </div>

        <!-- Scrollable Table Container -->
        <div style="max-height: 400px; overflow-y: auto;" class="mx-4">
            <table class="table align-middle" style="border-spacing: 0 10px; border-collapse: separate;">
                <thead class="table">
                    <tr>
                        <th style="opacity: 0.3;">Service ID</th>
                        <th style="opacity: 0.3;">Unit Name</th>
                        <th style="opacity: 0.3;">Serial Number</th>
                        <th style="opacity: 0.3;">Client Name</th>
                        <th style="opacity: 0.3;">Warranty Type</th>
                        <!-- <th style="opacity: 0.3;">Usage</th> -->
                        <th style="opacity: 0.3;">Warranty Start</th>
                        <th style="opacity: 0.3;">End of Warranty</th>
                        <th style="opacity: 0.3;">Status</th>
                        <th style="opacity: 0.3;"></th>
                    </tr>
                </thead>

                <tbody id="aftersalesLogsBody">
                    {% for record in service_records %}
                    <tr style="background-color: #f9f9f9; border-radius: 10px; overflow: hidden;">
                        <td>{{ record.service_id }}</td>
                        <td>{{ record.unit_name }}</td>
                        <td>{{ record.serial_number }}</td>
                        <td>{{ record.client_name }}</td>
                        <td>{{ record.warranty_type }}</td>
                        <!-- <td>{{ record.usage_value }} {{ record.usage_unit }}</td> -->
                        <td>{{ record.warranty_start|date:"F j, Y" }}</td>
                        <td>{{ record.warranty_end|date:"F j, Y" }}</td>
                        <td>
                            <span style="background-color: rgb(202, 238, 204); border-radius: 5px;"
                                class="p-1 text-success">{{ record.status }}</span>
                        </td>
                        <td>
                            <a href="#" class="text-dark me-2" data-bs-toggle="modal" data-bs-target="#viewServiceRecordModal{{ record.service_id }}">
                                <i class="bi bi-chevron-right fs-5"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            No service records found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('aftersalesLogsBody');

    function renderRows(records) {
        if (!tbody) return;
        let html = '';
        records.forEach(function(rec) {
            html += '<tr style="background-color: #f9f9f9; border-radius: 10px; overflow: hidden;">' +
                '<td>' + rec.service_id + '</td>' +
                '<td>' + (rec.unit_name || '') + '</td>' +
                '<td>' + (rec.serial_number || '') + '</td>' +
                '<td>' + (rec.client_name || '') + '</td>' +
                '<td>' + (rec.warranty_type || '') + '</td>' +
                '<td>' + (rec.warranty_start || '') + '</td>' +
                '<td>' + (rec.warranty_end || '') + '</td>' +
                '<td><span style="background-color: rgb(202, 238, 204); border-radius: 5px;" class="p-1 text-success">' + (rec.status || '') + '</span></td>' +
                '<td><a href="#" class="text-dark me-2" data-bs-toggle="modal" data-bs-target="#viewServiceRecordModal' + rec.service_id + '"><i class="bi bi-chevron-right fs-5"></i></a></td>' +
            '</tr>';
        });
        if (!records.length) {
            html = '<tr><td colspan="10" class="text-center text-muted py-4">No service records found</td></tr>';
        }
        tbody.innerHTML = html;
    }

    function fetchLogs() {
        fetch('{% url "aftersales_logs_feed" %}', { credentials: 'same-origin' })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                const items = data && Array.isArray(data.records) ? data.records : [];
                renderRows(items);
                if (typeof fetchNotifications === 'function') {
                    fetchNotifications();
                }
            })
            .catch(function(err) { console.error('Aftersales feed error:', err); });
    }

    fetchLogs();
    setInterval(fetchLogs, 5000);
});
</script>
{% for record in service_records %}
    {% include 'aftersales_modals/service_records_modals/view_service_record_modal.html' with record=record %}
    {% for maintenance in record.completed_maintenance_records %}
        {% with service=record %}
            {% include 'aftersales_modals/maintenance_schedule_modals/view_schedule_modal.html' with maintenance=maintenance service=service %}
        {% endwith %}
    {% endfor %}
{% endfor %}

{% endblock %}